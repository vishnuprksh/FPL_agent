# Final Predictions Table

## Overview

The `final_predictions` table contains predicted points for all players across all remaining fixtures in the season. This table is generated by the `scripts/create_final_predictions.py` script.

## Table Schema

```sql
CREATE TABLE final_predictions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    player_id INTEGER NOT NULL,
    player_name TEXT NOT NULL,
    player_web_name TEXT NOT NULL,
    element_type INTEGER NOT NULL,
    element_type_name TEXT NOT NULL,
    team_id INTEGER NOT NULL,
    team_name TEXT NOT NULL,
    fixture_id INTEGER NOT NULL,
    gameweek INTEGER,
    kickoff_time TEXT NOT NULL,
    is_home BOOLEAN NOT NULL,
    opponent_id INTEGER NOT NULL,
    opponent_name TEXT NOT NULL,
    own_team_attack REAL NOT NULL,
    own_team_defense REAL NOT NULL,
    opponent_attack REAL NOT NULL,
    opponent_defense REAL NOT NULL,
    predicted_points REAL NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (player_id) REFERENCES elements(id),
    FOREIGN KEY (team_id) REFERENCES teams(id),
    FOREIGN KEY (fixture_id) REFERENCES fixtures(id),
    FOREIGN KEY (opponent_id) REFERENCES teams(id)
);
```

## How Predictions are Generated

1. **Remaining Fixtures**: The script identifies all fixtures where `finished = 0` in the fixtures table
2. **Player-Fixture Mapping**: For each player, rows are created for all fixtures involving their team
3. **Team Valuations**: Latest attack and defense values are fetched from `team_fixture_valuations` table
4. **ML Prediction**: Using the trained models from `models/player_points_predictors.pkl`, points are predicted based on:
   - Own team attack value
   - Own team defense value
   - Opponent attack value
   - Opponent defense value
5. **Storage**: All predictions are stored with complete context for analysis

## Key Statistics

- **Total Predictions**: 20,944 rows (as of last run)
- **Players Covered**: 748 unique players
- **Fixtures Covered**: 280 remaining fixtures (~28 fixtures per player on average)
- **Models Used**: 740 trained ML models (8 players without models get 0 predicted points)

## Useful SQL Queries

### 1. Top Players by Total Predicted Points (Season Total)

```sql
SELECT 
    player_web_name,
    team_name,
    element_type_name,
    SUM(predicted_points) as total_predicted_points,
    COUNT(*) as num_fixtures,
    AVG(predicted_points) as avg_per_fixture
FROM final_predictions
GROUP BY player_id
ORDER BY total_predicted_points DESC
LIMIT 20;
```

### 2. Best Players for Next Gameweek

```sql
SELECT 
    gameweek,
    player_web_name,
    team_name,
    opponent_name,
    CASE WHEN is_home = 1 THEN 'H' ELSE 'A' END as venue,
    predicted_points,
    own_team_attack,
    own_team_defense,
    opponent_attack,
    opponent_defense
FROM final_predictions
WHERE gameweek = (
    SELECT MIN(gameweek) 
    FROM final_predictions 
    WHERE kickoff_time > datetime('now')
)
ORDER BY predicted_points DESC
LIMIT 20;
```

### 3. Player's Upcoming Fixtures and Predictions

```sql
SELECT 
    gameweek,
    kickoff_time,
    team_name,
    opponent_name,
    CASE WHEN is_home = 1 THEN 'H' ELSE 'A' END as venue,
    predicted_points,
    own_team_attack,
    opponent_defense
FROM final_predictions
WHERE player_web_name = 'Haaland'
ORDER BY kickoff_time
LIMIT 10;
```

### 4. Best Fixtures for Teams (Highest Predicted Team Total)

```sql
SELECT 
    gameweek,
    team_name,
    opponent_name,
    CASE WHEN is_home = 1 THEN 'H' ELSE 'A' END as venue,
    SUM(predicted_points) as team_total,
    COUNT(*) as num_players,
    AVG(predicted_points) as avg_per_player
FROM final_predictions
GROUP BY fixture_id, team_id
ORDER BY team_total DESC
LIMIT 20;
```

### 5. Players by Position for Specific Gameweek

```sql
-- Forwards for GW 11
SELECT 
    player_web_name,
    team_name,
    opponent_name,
    CASE WHEN is_home = 1 THEN 'H' ELSE 'A' END as venue,
    predicted_points
FROM final_predictions
WHERE gameweek = 11 
    AND element_type_name = 'Forward'
ORDER BY predicted_points DESC
LIMIT 10;

-- Midfielders for GW 11
SELECT 
    player_web_name,
    team_name,
    opponent_name,
    CASE WHEN is_home = 1 THEN 'H' ELSE 'A' END as venue,
    predicted_points
FROM final_predictions
WHERE gameweek = 11 
    AND element_type_name = 'Midfielder'
ORDER BY predicted_points DESC
LIMIT 10;
```

### 6. Fixture Difficulty Analysis (Easiest Upcoming Fixtures)

```sql
SELECT 
    gameweek,
    team_name,
    opponent_name,
    AVG(predicted_points) as avg_predicted_points,
    opponent_defense,
    opponent_attack
FROM final_predictions
GROUP BY fixture_id, team_id
HAVING gameweek BETWEEN 11 AND 15
ORDER BY avg_predicted_points DESC
LIMIT 20;
```

### 7. Best Differential Picks (Lower Ownership, High Predictions)

```sql
SELECT 
    fp.player_web_name,
    fp.team_name,
    e.selected_by_percent,
    SUM(fp.predicted_points) as total_predicted,
    e.now_cost / 10.0 as price
FROM final_predictions fp
JOIN elements e ON fp.player_id = e.id
WHERE fp.gameweek BETWEEN 11 AND 15
GROUP BY fp.player_id
HAVING e.selected_by_percent < 10.0
ORDER BY total_predicted DESC
LIMIT 20;
```

### 8. Best Captain Options (Next 3 Gameweeks)

```sql
SELECT 
    player_web_name,
    team_name,
    SUM(predicted_points) as total_next_3gw,
    AVG(predicted_points) as avg_per_game,
    COUNT(*) as num_fixtures
FROM final_predictions
WHERE gameweek IN (
    SELECT DISTINCT gameweek 
    FROM final_predictions 
    ORDER BY gameweek 
    LIMIT 3
)
GROUP BY player_id
ORDER BY total_next_3gw DESC
LIMIT 20;
```

### 9. Home vs Away Performance

```sql
SELECT 
    player_web_name,
    team_name,
    SUM(CASE WHEN is_home = 1 THEN predicted_points ELSE 0 END) as home_points,
    SUM(CASE WHEN is_home = 0 THEN predicted_points ELSE 0 END) as away_points,
    SUM(predicted_points) as total_points
FROM final_predictions
GROUP BY player_id
HAVING total_points > 50
ORDER BY total_points DESC
LIMIT 20;
```

### 10. Teams with Easiest/Hardest Run of Fixtures

```sql
-- Easiest fixture runs (next 5 gameweeks)
SELECT 
    team_name,
    AVG(predicted_points) as avg_team_performance,
    COUNT(DISTINCT gameweek) as gameweeks,
    COUNT(DISTINCT player_id) as squad_size
FROM final_predictions
WHERE gameweek BETWEEN 11 AND 15
GROUP BY team_name
ORDER BY avg_team_performance DESC;
```

## Regenerating Predictions

To regenerate the predictions table (e.g., after updating team valuations or retraining models):

```bash
python scripts/create_final_predictions.py
```

This will:
1. Drop the existing `final_predictions` table
2. Recreate it with fresh predictions
3. Display summary statistics and sample results

## Notes

- Players without trained ML models are assigned 0 predicted points
- Predictions use the **latest** team valuations from `team_fixture_valuations` table
- The `is_home` field indicates whether the player's team is playing at home (1) or away (0)
- All predictions are generated at once and stored, making queries very fast
- Indices are created on `player_id`, `fixture_id`, and `team_id` for optimal query performance

## Integration with Other Scripts

The final predictions table can be used by:
- `scripts/create_best_team.py` - To build optimal squad selections
- `scripts/optimize_transfers.py` - To plan transfers based on predicted performance
- `ui/app.py` - To display predictions in the web interface
- Custom analysis scripts for fantasy football strategy
